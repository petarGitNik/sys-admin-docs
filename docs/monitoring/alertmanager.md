# Alertmanager

Create a separate user that will be used to run this application:

```bash
sudo adduser --no-create-home --disabled-login --shell /bin/false --gecos "Alertmanager User" alertmanager
```

Next thing you have to do is to create necessary directories and dummy configuration files:

```bash
sudo mkdir /etc/alertmanager
sudo mkdir /etc/alertmanager/template
sudo mkdir -p /var/lib/alertmanager/data
sudo touch /etc/alertmanager/alertmanager.yml
```

`/etc/alertmanager` will be used to store configuration (`aletmanager.yml`) and template (located in `template/`) files. Data generated by the alertmanager will be stored `/var/lib/alertmanager`. The rationale to store data in that folder is explained [here][3][^1][^2] and [here][4][^3][^4]. Look at the `/var/lib` section for explanation (tl;dr UNIX standard).

Now that the directories are created, we have to change their ownership, so that the `alertmanager` user could use them:

```bash
sudo chown -R alertmanager:alertmanager /etc/alertmanager
sudo chown -R alertmanager:alertmanager /var/lib/alertmanager
```

Download the latest alertmanager (go to [official github repo][5], and under _releases_ tab find the latest release, you can also download it from the officail [prometheus][6] site):

```bash
wget https://github.com/prometheus/alertmanager/releases/download/v0.12.0/alertmanager-0.12.0.linux-amd64.tar.gz
tar xvzf alertmanager-0.12.0.linux-amd64.tar.gz
```

Copy utilities to appropriate places in the filesystem:

```bash
sudo cp alertmanager-0.12.0.linux-amd64/alertmanager /usr/local/bin/
sudo cp alertmanager-0.12.0.linux-amd64/amtool /usr/local/bin/
```

And make sure that `alertmanager` user owns them:

```bash
sudo chown alertmanager:alertmanager /usr/local/bin/alertmanager
sudo chown alertmanager:alertmanager /usr/local/bin/amtool
```

Next, we will add some very generic configuration:

```bash
sudo vi /etc/alertmanager/alertmanager.yml
```

Add this to your configuration file:

```yaml
global:
  smtp_smarthost: 'localhost:25'
  smtp_from: 'alertmanager@example.org'
  smtp_auth_username: 'alertmanager'
  smtp_auth_password: 'password'

templates:
- '/etc/alertmanager/template/*.tmpl'

route:
  repeat_interval: 3h
  receiver: team-X-mails

receivers:
- name: 'team-X-mails'
  email_configs:
  - to: 'team-X+alerts@example.org'
```

<!-- add TLS encryption for alertmanager -->

At this point I will assume that you know how to configure the alertmanager yaml file. The simple example file should be enough to get you started with the simplest use case (sending mail notification through third party smtp such as _smtp.gmail.com_). If you are using the alertmanager for small home project, or think that self-hosted mail servers or third party servers are an overkill, you can configure the alertmanager to notify you using your personal gmail (see [here][7][^5][^6]).

Next thing we have to do is to setup alertmanager as systemd unit:

```bash
sudo vi /etc/systemd/system/alertmanager.service
```

Copy and paste this into the editor:

```ini
[Unit]
Description=Prometheus Alertmanager Service
Wants=network-online.target
After=network.target

[Service]
User=alertmanager
Group=alertmanager
Type=simple
ExecStart=/usr/local/bin/alertmanager \
    --config.file /etc/alertmanager/alertmanager.yml \
    --storage.path /var/lib/alertmanager/data
Restart=always

[Install]
WantedBy=multi-user.target
```

After that, reload daemons, enable alertmanager service on startup, and restart it.

```bash
sudo systemctl daemon-reload
sudo systemctl enable alertmanager
sudo systemctl start alertmanager
```

Don't forget to clean up after yourself:

```bash
rm alertmanager-0.12.0.linux-amd64.tar.gz
rm -rf alertmanager-0.12.0.linux-amd64
```

And that's it. The only thing we have to do is to edit the prometheus configuration file so it could be aware of the alertmanager. Add this to the `/etc/prometheus/prometheus.yml` file:

```yaml
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - localhost:9093
```

Whew...

[^1]: <https://web.archive.org/web/20180402114018/https://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/Linux-Filesystem-Hierarchy.html>
[^2]: _Error Network error_ <>
[^3]: <https://web.archive.org/web/20180402114151/http://www.pathname.com/fhs/pub/fhs-2.3.html>
[^4]: <http://archive.li/CUS6u>
[^5]: <https://web.archive.org/web/20180402115052/https://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/>
[^6]: <http://archive.is/4tigv>

[3]: https://www.tldp.org/LDP/Linux-Filesystem-Hierarchy/html/Linux-Filesystem-Hierarchy.html#var
[4]: http://www.pathname.com/fhs/pub/fhs-2.3.html#VARLIBVARIABLESTATEINFORMATION
[5]: https://github.com/prometheus/alertmanager
[6]: https://prometheus.io/download/
[7]: https://www.robustperception.io/sending-email-with-the-alertmanager-via-gmail/
